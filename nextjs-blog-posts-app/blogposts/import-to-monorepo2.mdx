---
title: Extract a Local Subfolder’s History into a Monorepo
description: Beginner-friendly, line-by-line explanation of a bash script that extracts a local subfolder’s history and merges it into your monorepo under a clean directory.
date: 2025-10-28
tags: [git, monorepo, tutorial, beginner]
---

> **TL;DR**: This guide walks through a bash script that imports history from one repo (or a subfolder) into a monorepo — safely — and opens a PR at the end. You’ll see the full script first, then a **line‑by‑line** explanation.

## Prerequisites

- Git installed (2.30+ recommended).
- `git-filter-repo` installed (the modern replacement for `git filter-branch`).  
  - Install via pip: `pip install git-filter-repo`  
  - Or follow the official instructions from the Git project.
- Access to your source repo and your monorepo on GitHub.
- Basic terminal skills (cd, chmod).

## Quick Start: How to run this file

1. Save this script as `script.sh` (or use your filename).
2. Make it executable:

   ```bash
   chmod +x script.sh
   ```

3. Edit the variables in the **EDIT THESE** section to match your repos.
4. Run it:

   ```bash
   ./script.sh
   ```

If something fails, because we used `set -e`, the script exits early so you can fix the issue safely.

## The full script (unchanged)

```bash
#!/bin/bash
set -e

# === EDIT THESE 2 LINES ===
SRC_DIR="/c/Users/tsdim/OneDrive/Desktop/JS"                     # local path to the repo containing the folder
SUBFOLDER_PATH="NextJs/Learning/my-app3"           # path to the subfolder you want to extract
FOLDER="nextjs-blog-posts-app"                  # name for the folder in the target repo

# === Usually no edits below ===
MONO_REMOTE="https://github.com/dimitrov93/Projects.git"   # target monorepo remote
MONO_DIR="/c/Users/tsdim/OneDrive/Desktop/Projects"                          # local clone of target monorepo
STAMP="$(date +%Y%m%d%H%M%S)"
IMPORT_BRANCH="import-${FOLDER}-history-${STAMP}"
MERGE_BRANCH="merge-${FOLDER}-${STAMP}"

echo "=== Prepare temporary workspace ==="
mkdir -p ~/temp-imports && cd ~/temp-imports
rm -rf src.git

echo "=== Clone source repo (bare) ==="
git clone --no-local --no-tags --bare "$SRC_DIR" src.git
cd src.git

echo "=== Extract history for subfolder: $SUBFOLDER_PATH ==="
git filter-repo --subdirectory-filter "$SUBFOLDER_PATH"

echo "=== Rewrite commits under new path: $FOLDER ==="
git filter-repo --to-subdirectory-filter "$FOLDER"

echo "=== Push rewritten history to Projects as $IMPORT_BRANCH ==="
git remote add monorepo "$MONO_REMOTE" 2>/dev/null || true
git push -u monorepo HEAD:refs/heads/$IMPORT_BRANCH

echo "=== Merge into local Projects repo ==="
cd "$MONO_DIR"
git fetch origin $IMPORT_BRANCH

# detect default branch (master/main)
DEFBR=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')

git checkout "$DEFBR"
git pull
git checkout -b "$MERGE_BRANCH"
git merge --allow-unrelated-histories "origin/$IMPORT_BRANCH" -m "Merge full $FOLDER history (extracted from JS/$SUBFOLDER_PATH)"
git push -u origin "$MERGE_BRANCH"

echo "=== Done ==="
echo "Open a PR: $MERGE_BRANCH -> $DEFBR in dimitrov93/Projects"
echo "After merging, verify with:"
echo "  git -C "$MONO_DIR" log --oneline --graph --decorate --full-history -- "$FOLDER" | head -n 20"
```

## Line‑by‑line explanation (for beginners)

- `#!/bin/bash`

  Shebang: run this file with **bash**.
- `set -e`

  Exit immediately if any command fails (safer scripts).
- ``

  Runs this command.
- `# === EDIT THESE 2 LINES ===`

  Section header: lines you typically customize.
- `SRC_DIR="/c/Users/tsdim/OneDrive/Desktop/JS"                     # local path to the repo containing the folder`

  Local path to the **source repository** on your machine.
- `SUBFOLDER_PATH="NextJs/Learning/my-app3"           # path to the subfolder you want to extract`

  Path to the **specific subfolder** whose history you want to extract.
- `FOLDER="nextjs-blog-posts-app"                  # name for the folder in the target repo`

  The final folder name inside the monorepo where files will live.
- ``

  Runs this command.
- `# === Usually no edits below ===`

  Comment: information for humans; ignored by bash.
- `MONO_REMOTE="https://github.com/dimitrov93/Projects.git"   # target monorepo remote`

  HTTPS URL of your **target monorepo** on GitHub.
- `MONO_DIR="/c/Users/tsdim/OneDrive/Desktop/Projects"                          # local clone of target monorepo`

  Local path where your **monorepo** is cloned.
- `STAMP="$(date +%Y%m%d%H%M%S)"`

  Timestamp used to generate **unique branch names**.
- `IMPORT_BRANCH="import-${FOLDER}-history-${STAMP}"`

  Name of the temporary branch that will hold the rewritten history.
- `MERGE_BRANCH="merge-${FOLDER}-${STAMP}"`

  Name of the branch used to merge the imported history into your monorepo.
- ``

  Runs this command.
- `echo "=== Prepare temporary workspace ==="`

  Progress message printed to your terminal.
- `mkdir -p ~/temp-imports && cd ~/temp-imports`

  Create a temp folder for the operation and **cd** into it.
- `rm -rf src.git`

  Ensure any previous temp repo is removed.
- ``

  Runs this command.
- `echo "=== Clone source repo (bare) ==="`

  Progress message printed to your terminal.
- `git clone --no-local --no-tags --bare "$SRC_DIR" src.git`

  Clone a local repo in a way that **copies** objects (Windows-friendly), bare mode.
- `cd src.git`

  Move into the temporary bare repo.
- ``

  Runs this command.
- `echo "=== Extract history for subfolder: $SUBFOLDER_PATH ==="`

  Progress message printed to your terminal.
- `git filter-repo --subdirectory-filter "$SUBFOLDER_PATH"`

  Keep only the specified subfolder's history; drop everything else.
- ``

  Runs this command.
- `echo "=== Rewrite commits under new path: $FOLDER ==="`

  Progress message printed to your terminal.
- `git filter-repo --to-subdirectory-filter "$FOLDER"`

  Rewrite all files so they live under the specified subdirectory in history.
- ``

  Runs this command.
- `echo "=== Push rewritten history to Projects as $IMPORT_BRANCH ==="`

  Progress message printed to your terminal.
- `git remote add monorepo "$MONO_REMOTE" 2>/dev/null || true`

  Add your monorepo as a remote named **monorepo**.
- `git push -u monorepo HEAD:refs/heads/$IMPORT_BRANCH`

  Push the rewritten history to the monorepo as a **new branch**.
- ``

  Runs this command.
- `echo "=== Merge into local Projects repo ==="`

  Progress message printed to your terminal.
- `cd "$MONO_DIR"`

  Move into your local monorepo clone.
- `git fetch origin $IMPORT_BRANCH`

  Fetch the newly pushed **import branch** from GitHub.
- ``

  Runs this command.
- `# detect default branch (master/main)`

  Comment: information for humans; ignored by bash.
- `DEFBR=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')`

  Detect whether the default branch is **main** or **master**.
- ``

  Runs this command.
- `git checkout "$DEFBR"`

  Switch to the default branch in your monorepo.
- `git pull`

  Update your local default branch with the latest remote changes.
- `git checkout -b "$MERGE_BRANCH"`

  Create a **new branch** where you’ll perform the merge.
- `git merge --allow-unrelated-histories "origin/$IMPORT_BRANCH" -m "Merge full $FOLDER history (extracted from JS/$SUBFOLDER_PATH)"`

  Merge the import branch into your monorepo (histories were previously unrelated).
- `git push -u origin "$MERGE_BRANCH"`

  Push your merge branch to GitHub so you can open a PR.
- ``

  Runs this command.
- `echo "=== Done ==="`

  Progress message printed to your terminal.
- `echo "Open a PR: $MERGE_BRANCH -> $DEFBR in dimitrov93/Projects"`

  Progress message printed to your terminal.
- `echo "After merging, verify with:"`

  Progress message printed to your terminal.
- `echo "  git -C "$MONO_DIR" log --oneline --graph --decorate --full-history -- "$FOLDER" | head -n 20"`

  Progress message printed to your terminal.

---

## What to do after the PR is merged

- Delete the temporary **import** and **merge** branches if you don’t need them anymore.
- Pull the default branch locally and verify the files exist at the right path.
- Optionally tag the merge commit:

  ```bash
  git tag -a imported-extract-a-local-subfolder’s-history-into-a-monorepo-2025-10-28 -m "Imported Extract a Local Subfolder’s History into a Monorepo"
  git push --tags
  ```

## Common errors and fixes

- **`git: 'filter-repo' is not a git command`** → Install `git-filter-repo` and ensure it’s on your PATH.
- **Permission denied (publickey)** when pushing → Fix your SSH keys or use HTTPS with a token.
- **Merge conflicts** → Open the files, resolve conflicts, `git add .`, and `git commit` on the merge branch, then push again.
